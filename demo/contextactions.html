<!doctype html>
<html>
<head>
  <title>CodeMirror: Context action demo</title>
  <meta charset="utf-8"/>
  <link rel=stylesheet href="../doc/docs.css">

  <link rel="stylesheet" href="../node_modules/codemirror/lib/codemirror.css">
  <link rel="stylesheet" href="../addon/contextactions/contextactions.css">
  <script src="../node_modules/codemirror/lib/codemirror.js"></script>
  <script src="../node_modules/codemirror/mode/javascript/javascript.js"></script>
  <script src="../node_modules/acorn/dist/acorn.js"></script>
  <script src="../node_modules/acorn/dist/walk.js"></script>
  <script src="../addon/contextactions/contextactions.js"></script>
  <style type="text/css">
    .CodeMirror {border-top: 1px solid #eee; border-bottom: 1px solid #eee; line-height: 1.3; height: 500px}
  </style>
</head>
<body>
  <div id=nav>
    <a href="http://codemirror.net"><h1>CodeMirror</h1></a>
    <ul>
      <li><a class=active href="#">Context actions</a>
    </ul>
  </div>

  <article>
    <h2>Context actions demo</h2>
    <textarea id="code">
var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
  lineNumbers: true,
  mode: "text/javascript",
  tabSize: 2,
  contextActions: { getActions: getActions },
  gutters: [
    'CodeMirror-contextactions-gutter'
  ]
});

function getActions(cm, pos) {
  var tree = acorn.parse(cm.getValue(), { ranges: true });
  var index = cm.indexFromPos(pos);
  var found = acorn.walk.findNodeAround(tree, index, function(type) {
    return type !== 'VariablePattern'
        && type !== 'Pattern'
        && type !== 'VariableDeclarator';
  });
  var node = found.node;
  if (!found || !node || node.type !== 'VariableDeclaration')
    return;

  var actions = [];
  if (node.kind !== 'let')
    actions.push(actionConvertTo('let', node));
  if (node.kind !== 'const')
    actions.push(actionConvertTo('const', node));
  if (node.kind !== 'var')
    actions.push(actionConvertTo('var', node));
  return actions;
}

function actionConvertTo(newKind, node) {
  return {
    text: 'Convert to ' + newKind,
    action: function(cm) {
      cm.replaceRange(newKind, cm.posFromIndex(node.start), cm.posFromIndex(node.start + node.kind.length));
    }
  };
}
    </textarea>
    <script>eval(document.getElementById("code").value);</script>
  </article>
</body>
